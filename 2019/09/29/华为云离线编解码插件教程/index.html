<!DOCTYPE html><html lang="null"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Bean's blog"><meta name="keywords" content="xbean1028,software"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style-dark.css?v=2.0.4"><link rel="stylesheet" type="text/css" href="/css/highlight-dark.css?v=2.0.4"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><title>华为云离线编解码插件教程 | Bean Panda</title></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">华为云离线编解码插件教程</h1><a id="logo" href="/.">Bean Panda</a><p class="description">软件小白，江山点墨</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Start</i></a><a href="/archives/"><i class="fa fa-archive"> Archiv</i></a><a href="/about/"><i class="fa fa-user"> Über</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Suche"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">华为云离线编解码插件教程</h1><div class="post-meta"><a href="/2019/09/29/华为云离线编解码插件教程/#comments" class="comment-count"></a><p><span class="date">Sep 29, 2019</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>Schlägt</i></i></span></p></div><div class="post-content"><h2 id="华为云编解码插件教程"><a href="#华为云编解码插件教程" class="headerlink" title="华为云编解码插件教程"></a>华为云编解码插件教程</h2><h3 id="一、-环境搭建"><a href="#一、-环境搭建" class="headerlink" title="一、    环境搭建"></a>一、    环境搭建</h3><p>JDK 1.8以上</p>
<p>eclipse</p>
<p>Maven</p>
<p>具体说明<a href="https://support.huaweicloud.com/devg-IoT/iot_02_4020.html" target="_blank" rel="noopener">https://support.huaweicloud.com/devg-IoT/iot_02_4020.html</a></p>
<h3 id="二、-Profile说明"><a href="#二、-Profile说明" class="headerlink" title="二、    Profile说明"></a>二、    Profile说明</h3><p>Profile实际上是一系列关于设备模型的描述文件，每个文件都使用JSON格式（键值对）。</p>
<p>Profile中首先需要说明设备的基本信息，包括厂商ID，厂商名称，设备类型，接入协议，以及设备可以提供的哪些服务等；其次，profile中要针对每一项服务，用一个独立的文件进行详细描述。服务，可以理解为是对设备消息（上下行）功能的一个分类，一个服务就代表一类功能；每个服务下包含若干属性和命令，每个属性对应上报消息中的某一个数据，每个命令字段则对应下行消息中的某些字段。</p>
<p>可选在线开发，离线开发</p>
<p>官方说明<a href="https://support.huaweicloud.com/devg-IoT/iot_02_9991.html" target="_blank" rel="noopener">https://support.huaweicloud.com/devg-IoT/iot_02_9991.html</a></p>
<h3 id="三、-编解码插件编写"><a href="#三、-编解码插件编写" class="headerlink" title="三、    编解码插件编写"></a>三、    编解码插件编写</h3><p>从华为资源中心下载编解码插件Demo，并解压到本地。文件结构如下图所示：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9mb3J1bS1pbWcuaHVhd2VpY2xvdWQuY29tL2RhdGEvYXR0YWNobWVudC9mb3J1bS8yMDE5MDMvMjMvMTEyOTUzN2p5Y2FqZnMwZjdmZHExNC5wbmc?x-oss-process=image/format,png" alt="image.png"></p>
<p>下载地址<a href="https://developer.obs.cn-north-4.myhuaweicloud.com/manage/tool/CodecDemo/CodecDemo.zip" target="_blank" rel="noopener">https://developer.obs.cn-north-4.myhuaweicloud.com/manage/tool/CodecDemo/CodecDemo.zip</a></p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9zdXBwb3J0Lmh1YXdlaWNsb3VkLmNvbS9kZXZnLUlvVC9maWd1cmUvemgtY25faW1hZ2VfMDE4Nzc1OTI5MS5wbmc?x-oss-process=image/format,png" alt="img"></p>
<p>源代码在src文件夹下；编译生成的插件包在target文件夹下。src 文件夹包含 main 、test 两个子文件夹，main下存放源码，test下是单元测试代码。官网下载的Demo中，源码的路径是：src\main\java\com\Huawei\NBIoTDevice\WaterMeter，单元测试代码的路径是：src\test\java\com\Huawei\NBIoTDevice\WaterMeter。</p>
<p>插件源码文件有5个：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9mb3J1bS1pbWcuaHVhd2VpY2xvdWQuY29tL2RhdGEvYXR0YWNobWVudC9mb3J1bS8yMDE5MDMvMjMvMTEyOTU4aGV5Ymt1bnpybndjcGlhYS5wbmc?x-oss-process=image/format,png" alt="image.png"></p>
<h4 id="1、源文件说明"><a href="#1、源文件说明" class="headerlink" title="1、源文件说明"></a>1、源文件说明</h4><p>a)    ProtocolAdapterImpl.java 可以理解为是插件的入口文件，对外提供调用接口。该文件只需要修改两个字符串的定义即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 厂商名称</span><br><span class="line"></span><br><span class="line">private static final String MANU_FACTURERID = &quot;Huawei&quot;;</span><br><span class="line"></span><br><span class="line">// 设备型号</span><br><span class="line"></span><br><span class="line">private static final String MODEL = &quot;NBIoTDevice&quot;;</span><br></pre></td></tr></table></figure>

<p>修改为profile当中定义的厂商ID和设备型号。</p>
<p>b)    CmdProcess.java 实现下行命令的编码工作，将从收到的服务器报文中提取出命令字段对应的内容，并将其转换成字节流。需要实现的函数是： <strong>public byte[]</strong> toByte()。</p>
<p>c)    ReportProcess.java 实现将收到的二进制码流按照格式解码出对应profile中的属性值，并生成JSON格式。需要实现的函数是：</p>
<p><strong>public</strong> ReportProcess(<strong>byte</strong>[] binaryData)，根据二进制码流的格式，从中取出对应字节，转换成profile中对应属性的值。</p>
<p><strong>public</strong> ObjectNode toJsonNode()，将解码出来的属性值封装成JSON格式。</p>
<p>d)    ByteBufUtils.java 和 Utilty.java文件封装了一些公共方法，不用做修改。也不会使用到。</p>
<h4 id="2、修改文件路径（包名）"><a href="#2、修改文件路径（包名）" class="headerlink" title="2、修改文件路径（包名）"></a>2、修改文件路径（包名）</h4><p>插件包名的要求是：com.厂商名称.设备型号.设备类型。因此下载下来的代码，要根据自己的设备修改下文件路径。即将Huawei文件夹重命名为profile中定义的厂商名称，NBIoTDevice文件夹重命名为profile中定义的设备型号，WaterMeter文件夹重命名为profile中定义的设备类型。注意：src\main 和src\test 下都要修改。在本例中，需要修改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src\main\java\com\ThirdParty\MyModel\MyTyp，</span><br><span class="line">src\test\java\com\ThirdParty\MyModel\MyType</span><br></pre></td></tr></table></figure>

<h4 id="3、修改pom-xml"><a href="#3、修改pom-xml" class="headerlink" title="3、修改pom.xml"></a>3、修改pom.xml</h4><p>打开pom.xml文件，修改第7行“artifactId”和第88行“Bundle-SymbolicName”的值为：设备类型-厂商ID-设备型号。在本例中，需要修改为：MyType-ThirdParty-MyModel。</p>
<h4 id="4-导入工程后是有错误的。"><a href="#4-导入工程后是有错误的。" class="headerlink" title="4. 导入工程后是有错误的。"></a>4. 导入工程后是有错误的。</h4><p>这是因为我们在第2节中将文件路径修改了，与代码里面的包路径不一致引起的。解决方法为：依次打开源文件，将第一行的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">package com.Huawei.NBIoTDevice.WaterMeter;</span><br><span class="line"></span><br><span class="line">修改为</span><br><span class="line"></span><br><span class="line">package com.ThirdParty.MyModel.MyType;</span><br></pre></td></tr></table></figure>

<p>打开OSGI_INF目录下的CodeProvideHandler.xml 文件：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9mb3J1bS1pbWcuaHVhd2VpY2xvdWQuY29tL2RhdGEvYXR0YWNobWVudC9mb3J1bS8yMDE5MDMvMjMvMTEzMDIyaHdkY21rdmxyYm9yZXV6aS5wbmc?x-oss-process=image/format,png" alt="image.png"></p>
<p>CodeProvideHandler.xml路径</p>
<p>打开后，文件内容如下图所示：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9mb3J1bS1pbWcuaHVhd2VpY2xvdWQuY29tL2RhdGEvYXR0YWNobWVudC9mb3J1bS8yMDE5MDMvMjMvMTEzMDI3OXdidzNoMGpkdzcybGZlNi5wbmc?x-oss-process=image/format,png" alt="image.png"></p>
<p>CodeProvideHandler.xml内容</p>
<p>将Name 、 Class* 内的路径也修改为对应的包路径：</p>
<p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9mb3J1bS1pbWcuaHVhd2VpY2xvdWQuY29tL2RhdGEvYXR0YWNobWVudC9mb3J1bS8yMDE5MDMvMjMvMTEzMDM1amlya3NsaHRwNWVmdmFzaC5wbmc?x-oss-process=image/format,png" alt="image.png"></p>
<p>CodeProvideHandler.xml修改</p>
<h4 id="5、代码实现"><a href="#5、代码实现" class="headerlink" title="5、代码实现"></a>5、代码实现</h4><h5 id="1）修改ProtocolAdatpterImpl-java文件"><a href="#1）修改ProtocolAdatpterImpl-java文件" class="headerlink" title="1）修改ProtocolAdatpterImpl.java文件"></a>1）修改ProtocolAdatpterImpl.java文件</h5><p>   在文件中找到如下两行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 厂商名称</span><br><span class="line">private static final String MANU_FACTURERID = &quot;Huawei&quot;;</span><br><span class="line">// 设备型号</span><br><span class="line">private static final String MODEL  = &quot;NBIoTDevice&quot;;</span><br></pre></td></tr></table></figure>

<p>将<strong>MANU_FACTURERID</strong> 和 <strong>MODEL</strong>定义修改为profile中定义的厂商ID和设备型号，本例中需要修改为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 厂商名称</span><br><span class="line">private static final String  MANU_FACTURERID = &quot;ThirdParty&quot;;</span><br><span class="line">// 设备型号</span><br><span class="line">private static final String MODEL  = &quot;MyModel&quot;;</span><br></pre></td></tr></table></figure>

<h5 id="2）解码实现"><a href="#2）解码实现" class="headerlink" title="2）解码实现"></a>2）解码实现</h5><p>解码，是将NB模组上报的二进制码流按格式解析出对应字段的过程。解码的代码在ReportProcess.java 文件中。</p>
<p>第一个函数：<strong>public</strong> ReportProcess(<strong>byte</strong>[] binaryData) 入参 byte[] binaryData就是NB模组上报的二进制码流。解码得到数据存储在成员变量当中。本例中的代码实现如下：</p>
<p>a.先看<strong>官方提供的例子：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> binaryData 设备发送给平台coap报文的payload部分</span></span><br><span class="line"><span class="comment">     *                   本例入参：AA 72 00 00 32 08 8D 03 20 62 33 99</span></span><br><span class="line"><span class="comment">     *                   byte[0]--byte[1]:  AA 72 命令头</span></span><br><span class="line"><span class="comment">     *                   byte[2]:   00 mstType 00表示设备上报数据deviceReq</span></span><br><span class="line"><span class="comment">     *                   byte[3]:   00 hasMore  0表示没有后续数据，1表示有后续数据，不带按照0处理</span></span><br><span class="line"><span class="comment">     *                   byte[4]--byte[11]:服务数据，根据需要解析//如果是deviceRsp,byte[4]表示是否携带mid, byte[5]--byte[6]表示短命令Id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReportProcess</span><span class="params">(<span class="keyword">byte</span>[] binaryData)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// identifier参数可以根据入参的码流获得，本例指定默认值123</span></span><br><span class="line">        <span class="comment">// identifier = "123";</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        如果是设备上报数据，返回格式为</span></span><br><span class="line"><span class="comment">        &#123;</span></span><br><span class="line"><span class="comment">            "identifier":"123",</span></span><br><span class="line"><span class="comment">            "msgType":"deviceReq",</span></span><br><span class="line"><span class="comment">            "hasMore":0,</span></span><br><span class="line"><span class="comment">            "data":[&#123;"serviceId":"Brightness",</span></span><br><span class="line"><span class="comment">                      "serviceData":&#123;"brightness":50&#125;,</span></span><br><span class="line"><span class="comment">                      &#123;</span></span><br><span class="line"><span class="comment">                      "serviceId":"Electricity",</span></span><br><span class="line"><span class="comment">                      "serviceData":&#123;"voltage":218.9,"current":800,"frequency":50.1,"powerfactor":0.98&#125;,</span></span><br><span class="line"><span class="comment">                      &#123;</span></span><br><span class="line"><span class="comment">                      "serviceId":"Temperature",</span></span><br><span class="line"><span class="comment">                      "serviceData":&#123;"temperature":25&#125;,</span></span><br><span class="line"><span class="comment">                      ]</span></span><br><span class="line"><span class="comment">	    &#125;</span></span><br><span class="line"><span class="comment">	    */</span></span><br><span class="line">        <span class="keyword">if</span> (binaryData[<span class="number">2</span>] == bDeviceReq) &#123;</span><br><span class="line">            msgType = <span class="string">"deviceReq"</span>;</span><br><span class="line">            hasMore = binaryData[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">            <span class="comment">//serviceId=Brightness 数据解析</span></span><br><span class="line">            brightness = binaryData[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">            <span class="comment">//serviceId=Electricity 数据解析</span></span><br><span class="line">            <span class="comment">////16进制转二进制然后移位，这里需要注意一下，我算了好久，emmm</span></span><br><span class="line">            voltage = (<span class="keyword">double</span>) (((binaryData[<span class="number">5</span>] &lt;&lt; <span class="number">8</span>) + (binaryData[<span class="number">6</span>] &amp; <span class="number">0xFF</span>)) * <span class="number">0.1f</span>);</span><br><span class="line">            current = (binaryData[<span class="number">7</span>] &lt;&lt; <span class="number">8</span>) + binaryData[<span class="number">8</span>];</span><br><span class="line">            powerfactor = (<span class="keyword">double</span>) (binaryData[<span class="number">9</span>] * <span class="number">0.01</span>);</span><br><span class="line">            frequency = (<span class="keyword">double</span>) binaryData[<span class="number">10</span>] * <span class="number">0.1f</span> + <span class="number">45</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//serviceId=Temperature 数据解析</span></span><br><span class="line">            temperature = (<span class="keyword">int</span>) binaryData[<span class="number">11</span>] &amp; <span class="number">0xFF</span> - <span class="number">128</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> ObjectNode <span class="title">toJsonNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//组装body体</span></span><br><span class="line">            ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">            ObjectNode root = mapper.createObjectNode();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// root.put("identifier", this.identifier);</span></span><br><span class="line">            root.put(<span class="string">"msgType"</span>, <span class="keyword">this</span>.msgType);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//根据msgType字段组装消息体</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.msgType.equals(<span class="string">"deviceReq"</span>)) &#123;</span><br><span class="line">                root.put(<span class="string">"hasMore"</span>, <span class="keyword">this</span>.hasMore);</span><br><span class="line">                ArrayNode arrynode = mapper.createArrayNode();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//serviceId=Brightness 数据组装</span></span><br><span class="line">                ObjectNode brightNode = mapper.createObjectNode();</span><br><span class="line">                brightNode.put(<span class="string">"serviceId"</span>, <span class="string">"Brightness"</span>);</span><br><span class="line">                ObjectNode brightData = mapper.createObjectNode();</span><br><span class="line">                brightData.put(<span class="string">"brightness"</span>, <span class="keyword">this</span>.brightness);</span><br><span class="line">                brightNode.put(<span class="string">"serviceData"</span>, brightData);</span><br><span class="line">                arrynode.add(brightNode);</span><br><span class="line">                <span class="comment">//serviceId=Electricity 数据组装</span></span><br><span class="line">                ObjectNode electricityNode = mapper.createObjectNode();</span><br><span class="line">                electricityNode.put(<span class="string">"serviceId"</span>, <span class="string">"Electricity"</span>);</span><br><span class="line">                ObjectNode electricityData = mapper.createObjectNode();</span><br><span class="line">                electricityData.put(<span class="string">"voltage"</span>, <span class="keyword">this</span>.voltage);</span><br><span class="line">                electricityData.put(<span class="string">"current"</span>, <span class="keyword">this</span>.current);</span><br><span class="line">                electricityData.put(<span class="string">"frequency"</span>, <span class="keyword">this</span>.frequency);</span><br><span class="line">                electricityData.put(<span class="string">"powerfactor"</span>, <span class="keyword">this</span>.powerfactor);</span><br><span class="line">                electricityNode.put(<span class="string">"serviceData"</span>, electricityData);</span><br><span class="line">                arrynode.add(electricityNode);</span><br><span class="line">                <span class="comment">//serviceId=Temperature 数据组装</span></span><br><span class="line">                ObjectNode temperatureNode = mapper.createObjectNode();</span><br><span class="line">                temperatureNode.put(<span class="string">"serviceId"</span>, <span class="string">"Temperature"</span>);</span><br><span class="line">                ObjectNode temperatureData = mapper.createObjectNode();</span><br><span class="line">                temperatureData.put(<span class="string">"temperature"</span>, <span class="keyword">this</span>.temperature);</span><br><span class="line">                temperatureNode.put(<span class="string">"serviceData"</span>, temperatureData);</span><br><span class="line">                arrynode.add(temperatureNode);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//serviceId=Connectivity 数据组装</span></span><br><span class="line">                ObjectNode ConnectivityNode = mapper.createObjectNode();</span><br><span class="line">                ConnectivityNode.put(<span class="string">"serviceId"</span>, <span class="string">"Connectivity"</span>);</span><br><span class="line">                ObjectNode  ConnectivityData = mapper.createObjectNode();</span><br><span class="line">                ConnectivityData.put(<span class="string">"signalStrength"</span>, <span class="number">5</span>);</span><br><span class="line">                ConnectivityData.put(<span class="string">"linkQuality"</span>, <span class="number">10</span>);</span><br><span class="line">                ConnectivityData.put(<span class="string">"cellId"</span>, <span class="number">9</span>);</span><br><span class="line">                ConnectivityNode.put(<span class="string">"serviceData"</span>, ConnectivityData);</span><br><span class="line">                arrynode.add(ConnectivityNode);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//serviceId=battery 数据组装</span></span><br><span class="line">                ObjectNode batteryNode = mapper.createObjectNode();</span><br><span class="line">                batteryNode.put(<span class="string">"serviceId"</span>, <span class="string">"battery"</span>);</span><br><span class="line">                ObjectNode batteryData = mapper.createObjectNode();</span><br><span class="line">                batteryData.put(<span class="string">"batteryVoltage"</span>, <span class="number">25</span>);</span><br><span class="line">                batteryData.put(<span class="string">"battervLevel"</span>, <span class="number">12</span>);</span><br><span class="line">                batteryNode.put(<span class="string">"serviceData"</span>, batteryData);</span><br><span class="line">                arrynode.add(batteryNode);</span><br><span class="line"></span><br><span class="line">                root.put(<span class="string">"data"</span>, arrynode);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                root.put(<span class="string">"errcode"</span>, <span class="keyword">this</span>.errcode);</span><br><span class="line">                <span class="comment">//此处需要考虑兼容性，如果没有传mid，则不对其进行解码</span></span><br><span class="line">                <span class="keyword">if</span> (isContainMid) &#123;</span><br><span class="line">                    root.put(<span class="string">"mid"</span>, <span class="keyword">this</span>.mid);<span class="comment">//mid</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//组装body体，只能为ObjectNode对象</span></span><br><span class="line">                ObjectNode body = mapper.createObjectNode();</span><br><span class="line">                body.put(<span class="string">"result"</span>, <span class="number">0</span>);</span><br><span class="line">                root.put(<span class="string">"body"</span>, body);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b.太长了，看我写的简陋的例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReportProcess</span><span class="params">(<span class="keyword">byte</span>[] binaryData)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        设备上报数据格式为 2020313939</span></span><br><span class="line"><span class="comment">        ACII码解码：  199</span></span><br><span class="line"><span class="comment">	    */</span></span><br><span class="line">    	msgType = <span class="string">"deviceReq"</span>;        <span class="comment">////设备上报标志</span></span><br><span class="line">    	light=<span class="number">0</span>;</span><br><span class="line">    	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++) &#123;</span><br><span class="line">    		<span class="keyword">if</span> (binaryData[i]==<span class="number">20</span>) &#123;</span><br><span class="line">    			binaryData[i]=<span class="number">00</span>;</span><br><span class="line">    		&#125;</span><br><span class="line">    		<span class="keyword">else</span> &#123;</span><br><span class="line">    			binaryData[i]=(<span class="keyword">byte</span>) ((<span class="keyword">int</span>)binaryData[i]&amp;<span class="number">0x0f</span>);</span><br><span class="line">    		&#125;	</span><br><span class="line">    	&#125;</span><br><span class="line">    	light =(<span class="keyword">int</span>) (((<span class="keyword">int</span>)binaryData[<span class="number">0</span>]*<span class="number">10000</span>)+((<span class="keyword">int</span>)binaryData[<span class="number">1</span>]*<span class="number">1000</span>)+((<span class="keyword">int</span>)binaryData[<span class="number">2</span>]*<span class="number">100</span>)+((<span class="keyword">int</span>)binaryData[<span class="number">3</span>]*<span class="number">10</span>)+((<span class="keyword">int</span>)binaryData[<span class="number">4</span>]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> ObjectNode <span class="title">toJsonNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//组装body体</span></span><br><span class="line">            <span class="comment">//注意serviceId 对应好</span></span><br><span class="line">            <span class="comment">/*public ObjectNode toJsonNode() 返回一个ObjectNode对象（JSON）。</span></span><br><span class="line"><span class="comment">            该函数的功能，是将解码后得到的数据，按照规定格式填入一个JSON对象中。</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">            ObjectNode root = mapper.createObjectNode();</span><br><span class="line">            root.put(<span class="string">"msgType"</span>, <span class="string">"deviceReq"</span>);</span><br><span class="line">            ArrayNode arrynode = mapper.createArrayNode();</span><br><span class="line"></span><br><span class="line">            ObjectNode serviceNode = mapper.createObjectNode();</span><br><span class="line">            ObjectNode serviceDataNode = mapper.createObjectNode();</span><br><span class="line">            serviceDataNode.put(<span class="string">"Light"</span>, <span class="keyword">this</span>.light);</span><br><span class="line">            serviceNode.put(<span class="string">"serviceId"</span>, <span class="string">"Light"</span>);</span><br><span class="line">            serviceNode.set(<span class="string">"serviceData"</span>, serviceDataNode);</span><br><span class="line">            arrynode.add(serviceNode);</span><br><span class="line">            </span><br><span class="line">            root.set(<span class="string">"data"</span>, arrynode);</span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/*JSON对象的内容格式要求是：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">"msgType":  "deviceReq",  表示设备上报数据，固定不动；“data”：数组对象，数组中的每个元素分别对应profile中的一个服务；“serviceID”的值是profile中定义的服务名称；“serviceData”的值是该服务下所有的属性值。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">该函数代码比较简单，主要是用到了 ObjectMapper 这个类，该类提供了JAVA中操作JSON数据的方法</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="3）编码实现"><a href="#3）编码实现" class="headerlink" title="3）编码实现"></a>3）编码实现</h5><p>修改CmdProcess.java中的代码，实现插件对下发命令和上报数据响应的编码能力。</p>
<p>a.同样，先看<strong>官方提供的例子：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CmdProcess</span><span class="params">(ObjectNode input)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// this.identifier = input.get("identifier").asText();</span></span><br><span class="line">            <span class="keyword">this</span>.msgType = input.get(<span class="string">"msgType"</span>).asText();</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            平台收到设备上报消息，编码ACK</span></span><br><span class="line"><span class="comment">            &#123;</span></span><br><span class="line"><span class="comment">                "identifier":"0",</span></span><br><span class="line"><span class="comment">                "msgType":"cloudRsp",</span></span><br><span class="line"><span class="comment">                "request": ***,//设备上报的码流</span></span><br><span class="line"><span class="comment">                "errcode":0,</span></span><br><span class="line"><span class="comment">                "hasMore":0</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            * */</span></span><br><span class="line">            <span class="keyword">if</span> (msgType.equals(<span class="string">"cloudRsp"</span>)) &#123;</span><br><span class="line">                <span class="comment">//在此组装ACK的值</span></span><br><span class="line">                <span class="keyword">this</span>.errcode = input.get(<span class="string">"errcode"</span>).asInt();</span><br><span class="line">                <span class="keyword">this</span>.hasMore = input.get(<span class="string">"hasMore"</span>).asInt();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            平台下发命令到设备，输入</span></span><br><span class="line"><span class="comment">            &#123;</span></span><br><span class="line"><span class="comment">                "identifier":0,</span></span><br><span class="line"><span class="comment">                "msgType":"cloudReq",</span></span><br><span class="line"><span class="comment">                "serviceId":"WaterMeter",</span></span><br><span class="line"><span class="comment">                "cmd":"SET_DEVICE_LEVEL",</span></span><br><span class="line"><span class="comment">                "paras":&#123;"value":"20"&#125;,</span></span><br><span class="line"><span class="comment">                "hasMore":0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            * */</span></span><br><span class="line">                <span class="comment">//此处需要考虑兼容性，如果没有传mId，则不对其进行编码</span></span><br><span class="line">                <span class="keyword">if</span> (input.get(<span class="string">"mid"</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.mid = input.get(<span class="string">"mid"</span>).intValue();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">this</span>.cmd = input.get(<span class="string">"cmd"</span>).asText();</span><br><span class="line">                <span class="keyword">this</span>.paras = input.get(<span class="string">"paras"</span>);</span><br><span class="line">                <span class="keyword">this</span>.hasMore = input.get(<span class="string">"hasMore"</span>).asInt();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] toByte() &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.msgType.equals(<span class="string">"cloudReq"</span>)) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                应用服务器下发的控制命令，本例只有一条控制命令：SET_DEVICE_LEVEL</span></span><br><span class="line"><span class="comment">                如果有其他控制命令，增加判断即可。</span></span><br><span class="line"><span class="comment">                * */</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.cmd.equals(<span class="string">"SET_DEVICE_LEVEL"</span>)) &#123;</span><br><span class="line">                    <span class="keyword">int</span> brightlevel = paras.get(<span class="string">"value"</span>).asInt();</span><br><span class="line">                    <span class="keyword">byte</span>[] byteRead = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">5</span>];</span><br><span class="line">                    ByteBufUtils buf = <span class="keyword">new</span> ByteBufUtils(byteRead);</span><br><span class="line">                    buf.writeByte((<span class="keyword">byte</span>) <span class="number">0xAA</span>);</span><br><span class="line">                    buf.writeByte((<span class="keyword">byte</span>) <span class="number">0x72</span>);</span><br><span class="line">                    buf.writeByte((<span class="keyword">byte</span>) brightlevel);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//此处需要考虑兼容性，如果没有传mId，则不对其进行编码</span></span><br><span class="line">                    <span class="keyword">if</span> (Utilty.getInstance().isValidofMid(mid)) &#123;</span><br><span class="line">                        <span class="keyword">byte</span>[] byteMid = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span>];</span><br><span class="line">                        byteMid = Utilty.getInstance().int2Bytes(mid, <span class="number">2</span>);</span><br><span class="line">                        buf.writeByte(byteMid[<span class="number">0</span>]);</span><br><span class="line">                        buf.writeByte(byteMid[<span class="number">1</span>]);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> byteRead;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            平台收到设备的上报数据，根据需要编码ACK，对设备进行响应，如果此处返回null，表示不需要对设备响应。</span></span><br><span class="line"><span class="comment">            * */</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.msgType.equals(<span class="string">"cloudRsp"</span>)) &#123;</span><br><span class="line">                <span class="keyword">byte</span>[] ack = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">                ByteBufUtils buf = <span class="keyword">new</span> ByteBufUtils(ack);</span><br><span class="line">                buf.writeByte((<span class="keyword">byte</span>) <span class="number">0xAA</span>);</span><br><span class="line">                buf.writeByte((<span class="keyword">byte</span>) <span class="number">0xAA</span>);</span><br><span class="line">                buf.writeByte((<span class="keyword">byte</span>) <span class="keyword">this</span>.errcode);</span><br><span class="line">                buf.writeByte((<span class="keyword">byte</span>) <span class="keyword">this</span>.hasMore)</span><br><span class="line">                <span class="keyword">return</span> ack;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> handle exception</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b.我写的简陋的例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] toByte() &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.msgType.equals(<span class="string">"cloudReq"</span>)) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                应用服务器下发的控制命令，本例只有一条控制命令：Control</span></span><br><span class="line"><span class="comment">                如果有其他控制命令，增加判断即可。</span></span><br><span class="line"><span class="comment">                * */</span></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">            	平台下发命令到设备，输入</span></span><br><span class="line"><span class="comment">                &#123;</span></span><br><span class="line"><span class="comment">                    "identifier":0,</span></span><br><span class="line"><span class="comment">                    "msgType":"cloudReq",</span></span><br><span class="line"><span class="comment">                    "serviceId":"Light",</span></span><br><span class="line"><span class="comment">                    "cmd":"Control",</span></span><br><span class="line"><span class="comment">                    "mid":0,</span></span><br><span class="line"><span class="comment">                    "paras":&#123;"LED":"ON"&#125;,</span></span><br><span class="line"><span class="comment">                    "hasMore":0</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.cmd.equals(<span class="string">"Control"</span>)) &#123;</span><br><span class="line">                	<span class="keyword">byte</span>[] downData = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">                	String Data = paras.get(<span class="string">"LED"</span>).asText();</span><br><span class="line">                	downData = Data.getBytes();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//此处需要考虑兼容性，如果没有传mId，则不对其进行编码</span></span><br><span class="line">                    <span class="keyword">if</span> (Utilty.getInstance().isValidofMid(mid)) &#123;</span><br><span class="line">                        <span class="keyword">byte</span>[] byteMid = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span>];</span><br><span class="line">                        byteMid = Utilty.getInstance().int2Bytes(mid, <span class="number">2</span>);</span><br><span class="line">                        buf.writeByte(byteMid[<span class="number">0</span>]);</span><br><span class="line">                        buf.writeByte(byteMid[<span class="number">1</span>]);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> downData;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">            平台收到设备的上报数据，根据需要编码ACK，对设备进行响应，如果此处返回null，表示不需要对设备响应。</span></span><br><span class="line"><span class="comment">            * */</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.msgType.equals(<span class="string">"cloudRsp"</span>)) &#123;</span><br><span class="line">                <span class="keyword">byte</span>[] ack = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">                ByteBufUtils buf = <span class="keyword">new</span> ByteBufUtils(ack);</span><br><span class="line">                buf.writeByte((<span class="keyword">byte</span>) <span class="number">0xAA</span>);</span><br><span class="line">                buf.writeByte((<span class="keyword">byte</span>) <span class="number">0xAA</span>);</span><br><span class="line">                buf.writeByte((<span class="keyword">byte</span>) <span class="keyword">this</span>.errcode);</span><br><span class="line">                buf.writeByte((<span class="keyword">byte</span>) <span class="keyword">this</span>.hasMore);</span><br><span class="line">                <span class="keyword">return</span> ack;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> handle exception</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">"msgType": "cloudReq", 固定值，表示服务器下行命令；</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">"serviceId"，profile中对应的服务，本例中是"Transmission",</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">"cmd"，profile中定义的下行命令，本例中是"CLOUDREQ",</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">"paras"，profile中定义的下行命令的各个字段</span></span><br><span class="line"><span class="comment">**/</span></span><br></pre></td></tr></table></figure>

<h4 id="6-编解码插件打包-以官网代码为例"><a href="#6-编解码插件打包-以官网代码为例" class="headerlink" title="6. 编解码插件打包  (以官网代码为例)"></a>6. 编解码插件打包  (以官网代码为例)</h4><p>插件变成完成后，需要使用Maven打包成jar包，并制作成插件包。</p>
<h5 id="Maven打包"><a href="#Maven打包" class="headerlink" title="Maven打包"></a><strong>Maven打包</strong></h5><ol>
<li><p>打开DOS窗口，进入“pom.xml”所在的目录。</p>
</li>
<li><p>输入maven打包命令：mvn package。</p>
</li>
<li><p>DOS窗口中显示“BUILD SUCCESS”后，打开与“pom.xml”目录同级的target文件夹，获取打包好的jar包。</p>
</li>
</ol>
<p>   jar包命名规范为：设备类型-厂商ID-设备型号-版本.jar，例如：WaterMeter-Huawei-NBIoTDevice-version.jar。</p>
<p>   <img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9zdXBwb3J0Lmh1YXdlaWNsb3VkLmNvbS9kZXZnLUlvVC9maWd1cmUvemgtY25faW1hZ2VfMDE5MzM5MzM4OS5wbmc?x-oss-process=image/format,png" alt="点击放大"></p>
<ul>
<li>com目录存放的是class文件。</li>
<li>META-INF下存放的是OSGI框架下的jar的描述文件（根据pom.xml配置生成的）。</li>
<li>OSGI-INF下存放的是服务配置文件，把编解码注册为服务，供平台调用（只能有一个xml文件）。</li>
<li>其他jar是编解码引用到的jar包。</li>
</ul>
<h5 id="制作插件包"><a href="#制作插件包" class="headerlink" title="制作插件包"></a><strong>制作插件包</strong></h5><ol>
<li><p>新建文件夹命名为“package”，包含一个“preload/”子文件夹。</p>
</li>
<li><p>将打包好的jar包放到“preload/”文件夹。</p>
</li>
</ol>
<p>   <img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9zdXBwb3J0Lmh1YXdlaWNsb3VkLmNvbS9kZXZnLUlvVC9maWd1cmUvemgtY25faW1hZ2VfMDE5MzM5MzQ1Ny5wbmc?x-oss-process=image/format,png" alt="点击放大"></p>
<ol start="3">
<li><p>在“package”文件夹中，新建“package-info.json”文件。该文件的字段说明和模板如下：</p>
<p>说明：</p>
<p>“package-info.json”需要以UTF-8无BOM格式编码。仅支持英文字符。</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>字段描述</th>
<th>是否必填</th>
</tr>
</thead>
<tbody><tr>
<td>specVersion</td>
<td>描述文件版本号，填写固定值：”1.0”。</td>
<td>是</td>
</tr>
<tr>
<td>fileName</td>
<td>软件包文件名，填写固定值：”codec-demo”</td>
<td>是</td>
</tr>
<tr>
<td>version</td>
<td>软件包版本号。描述package.zip的版本，请与下面的bundleVersion取值保持一致。</td>
<td>是</td>
</tr>
<tr>
<td>deviceType</td>
<td>设备类型，与Profile文件中的定义保持一致。</td>
<td>是</td>
</tr>
<tr>
<td>manufacturerName</td>
<td>制造商名称，与Profile文件中的定义保持一致，否则无法上传到平台。</td>
<td>是</td>
</tr>
<tr>
<td>model</td>
<td>产品型号，与Profile文件中的定义保持一致。</td>
<td>是</td>
</tr>
<tr>
<td>platform</td>
<td>平台类型，本插件包运行的物联网平台的操作系统，填写固定值：”linux”。</td>
<td>是</td>
</tr>
<tr>
<td>packageType</td>
<td>软件包类型，该字段用来描述本插件最终部署的平台模块，填写固定值：”CIGPlugin”。</td>
<td>是</td>
</tr>
<tr>
<td>date</td>
<td>出包时间，格式为：”yyyy-MM-dd HH-mm-ss”，如”2017-05-06 20:48:59”。</td>
<td>否</td>
</tr>
<tr>
<td>description</td>
<td>对软件包的自定义描述。</td>
<td>否</td>
</tr>
<tr>
<td>ignoreList</td>
<td>忽略列表，默认为空值。</td>
<td>是</td>
</tr>
<tr>
<td>bundles</td>
<td>一组bundle的描述信息。<strong>说明：</strong>bundle就是压缩包中的jar包，只需要写一个bundle。</td>
<td>是</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>字段名</th>
<th>字段描述</th>
<th>是否必填</th>
</tr>
</thead>
<tbody><tr>
<td>bundleName</td>
<td>插件名称，和上文中pom.xml的Bundle-SymbolicName保持一致。</td>
<td>是</td>
</tr>
<tr>
<td>bundleVersion</td>
<td>插件版本，与上面的version取值保持一致。</td>
<td>是</td>
</tr>
<tr>
<td>priority</td>
<td>插件优先级，可赋值默认值：5。</td>
<td>是</td>
</tr>
<tr>
<td>fileName</td>
<td>插件jar的文件名称。</td>
<td>是</td>
</tr>
<tr>
<td>bundleDesc</td>
<td>插件描述，用来介绍bundle功能。</td>
<td>是</td>
</tr>
<tr>
<td>versionDesc</td>
<td>插件版本描述，用来介绍版本更迭时的功能特性。</td>
<td>是</td>
</tr>
</tbody></table>
<p><strong>package-info.json</strong>文件模板：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">    <span class="attr">"specVersion"</span>:<span class="string">"1.0"</span>, </span><br><span class="line">    <span class="attr">"fileName"</span>:<span class="string">"codec-demo"</span>, </span><br><span class="line">    <span class="attr">"version"</span>:<span class="string">"1.0.0"</span>, </span><br><span class="line">    <span class="attr">"deviceType"</span>:<span class="string">"WaterMeter"</span>, </span><br><span class="line">    <span class="attr">"manufacturerName"</span>:<span class="string">"Huawei"</span>, </span><br><span class="line">    <span class="attr">"model"</span>:<span class="string">"NBIoTDevice"</span>, </span><br><span class="line">    <span class="attr">"description"</span>:<span class="string">"codec"</span>, </span><br><span class="line">    <span class="attr">"platform"</span>:<span class="string">"linux"</span>, </span><br><span class="line">    <span class="attr">"packageType"</span>:<span class="string">"CIGPlugin"</span>, </span><br><span class="line">    <span class="attr">"date"</span>:<span class="string">"2017-02-06 12:16:59"</span>, </span><br><span class="line">    <span class="attr">"ignoreList"</span>:[], </span><br><span class="line">    <span class="attr">"bundles"</span>:[ </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="attr">"bundleName"</span>: <span class="string">"WaterMeter-Huawei-NBIoTDevice"</span>, </span><br><span class="line">        <span class="attr">"bundleVersion"</span>: <span class="string">"1.0.0"</span>, </span><br><span class="line">        <span class="attr">"priority"</span>:<span class="number">5</span>, </span><br><span class="line">        <span class="attr">"fileName"</span>: <span class="string">"WaterMeter-Huawei-NBIoTDevice-1.0.0.jar"</span>, </span><br><span class="line">        <span class="attr">"bundleDesc"</span>:<span class="string">""</span>, </span><br><span class="line">        <span class="attr">"versionDesc"</span>:<span class="string">""</span> </span><br><span class="line">    &#125;] </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>选中“package”文件夹中的全部文件，打包成zip格式（“package.zip”）。</p>
</li>
</ol>
<p>   说明：</p>
<p>   <strong>“package.zip”中不能包含“package”这层目录。</strong></p>
<h4 id="7-编解码插件质检"><a href="#7-编解码插件质检" class="headerlink" title="7.编解码插件质检"></a>7.编解码插件质检</h4><p>编解码插件的质检用于检验编解码是否可以正常使用。</p>
<ol>
<li><p>获取<a href="https://developer.obs.cn-north-4.myhuaweicloud.com/manage/tool/CodecCheck/CodecCheck.zip" target="_blank" rel="noopener">编解码插件检测工具</a>。</p>
</li>
<li><p>将检测工具“pluginDetector.jar”、Profile文件的“devicetype-capability.json”和需要检测的编解码插件包“package.zip”和tool文件夹放在同一个目录下。</p>
</li>
</ol>
<p>   <img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9zdXBwb3J0Lmh1YXdlaWNsb3VkLmNvbS9kZXZnLUlvVC9maWd1cmUvemgtY25faW1hZ2VfMDE5MzM5MzQ1OC5wbmc?x-oss-process=image/format,png" alt="img"></p>
<p>   比较简单，具体参照 <a href="https://support.huaweicloud.com/devg-IoT/iot_02_4020.html" target="_blank" rel="noopener">官方教程</a></p>
<h4 id="8-编解码插件包离线签名"><a href="#8-编解码插件包离线签名" class="headerlink" title="8.编解码插件包离线签名"></a>8.编解码插件包离线签名</h4><pre><code>具体参照 [官方教程](https://support.huaweicloud.com/devg-IoT/iot_02_4020.html)</code></pre><h3 id="四、-附上我的Code"><a href="#四、-附上我的Code" class="headerlink" title="四、 附上我的Code"></a>四、 附上我的Code</h3><p><a href="https://github.com/Xbean1028/NB-IOT" target="_blank" rel="noopener">https://github.com/Xbean1028/NB-IOT</a></p>
<p>第一次学习，请多指教</p>
</div><div class="post-copyright"><blockquote><p>Ursprünglicher Autor: Bean</p><p>Ursprünglicher Link: <a href="http://yoursite.com/2019/09/29/华为云离线编解码插件教程/">http://yoursite.com/2019/09/29/华为云离线编解码插件教程/</a></p><p>Copyright-Erklärung: Bitte geben Sie die Quelle des Nachdrucks an.</p></blockquote></div><div class="tags"><a href="/tags/物联网/">物联网</a></div><div class="post-share"><div class="social-share"><span>Aktie:</span></div></div><div class="post-nav"><a href="/2019/09/29/git命令使用简单实用初始教程/" class="pre">git命令使用简单实用初始教程</a><a href="/2019/08/31/linux下打开win的NTFS硬盘总是提示出错/" class="next">linux下打开win的NTFS硬盘总是提示出错</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Inhalte</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#华为云编解码插件教程"><span class="toc-text">华为云编解码插件教程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#一、-环境搭建"><span class="toc-text">一、    环境搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、-Profile说明"><span class="toc-text">二、    Profile说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三、-编解码插件编写"><span class="toc-text">三、    编解码插件编写</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、源文件说明"><span class="toc-text">1、源文件说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、修改文件路径（包名）"><span class="toc-text">2、修改文件路径（包名）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3、修改pom-xml"><span class="toc-text">3、修改pom.xml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-导入工程后是有错误的。"><span class="toc-text">4. 导入工程后是有错误的。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5、代码实现"><span class="toc-text">5、代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1）修改ProtocolAdatpterImpl-java文件"><span class="toc-text">1）修改ProtocolAdatpterImpl.java文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2）解码实现"><span class="toc-text">2）解码实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3）编码实现"><span class="toc-text">3）编码实现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-编解码插件打包-以官网代码为例"><span class="toc-text">6. 编解码插件打包  (以官网代码为例)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Maven打包"><span class="toc-text">Maven打包</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#制作插件包"><span class="toc-text">制作插件包</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-编解码插件质检"><span class="toc-text">7.编解码插件质检</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#8-编解码插件包离线签名"><span class="toc-text">8.编解码插件包离线签名</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#四、-附上我的Code"><span class="toc-text">四、 附上我的Code</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Letzte</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/02/19/【读薄 CSAPP】壹 数据表示/">【读薄 CSAPP】壹 数据表示</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/18/【读薄 CSAPP】肆 链接/">【读薄 CSAPP】肆 链接</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/18/服务器+宝塔+Chevereto 搭建个人图床/">服务器+宝塔+Chevereto 搭建个人图床</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/17/【读薄 CSAPP】叁 内存与缓存/">【读薄 CSAPP】叁 内存与缓存</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/16/【读薄 CSAPP】贰 机器指令与程序优化/">【读薄 CSAPP】贰 机器指令与程序优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/15/SQL查询语句的基本使用方法/">SQL查询语句的基本使用方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/15/【读薄 CSAPP】零 系列概览/">【读薄 CSAPP】零 系列概览</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/09/python操作数据库（Mysql）/">python操作数据库（Mysql）</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/09/Python之Html解析方法(beautiful soup)/">Python之Html解析方法(beautiful soup)</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/03/hexo博客搭建（保姆级教程）/">hexo博客搭建（保姆级教程）</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"><a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/物联网/" style="font-size: 15px;">物联网</a> <a href="/tags/ubuntu/" style="font-size: 15px;">ubuntu</a> <a href="/tags/计算机视觉及测距/" style="font-size: 15px;">计算机视觉及测距</a> <a href="/tags/opencv/" style="font-size: 15px;">opencv</a> <a href="/tags/数据库/" style="font-size: 15px;">数据库</a> <a href="/tags/CSAPP/" style="font-size: 15px;">CSAPP</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archiv</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> Blogroll</i></div><ul></ul><a href="https://blog.csdn.net/xbean1028/" title="CSDN" target="_blank">CSDN</a><ul></ul><a href="https://github.com/Xbean1028/" title="github" target="_blank">github</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Sitemap</a> |  <a href="/atom.xml">Abonnieren Sie diese Site</a> |  <a href="/about/">Kontaktieren Sie den Blogger</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">Bean.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.4"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.4" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>